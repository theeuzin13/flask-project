{% extends "base.html" %}
{% block content %}

<h2>Shows</h2>

<div class="d-flex align-items-center gap-3 mb-3">
    <a href="/shows/new" class="btn btn-success">+ Novo Show</a>
    <a href="/clients" class="btn btn-success">+ Clientes</a>
    <a href="/places" class="btn btn-success">+ Locais</a>
</div>

<form class="row mb-3" method="GET">
    <div class="col-md-3">
        <input type="date" name="date" class="form-control" value="{{ request.args.get('date','') }}">
    </div>

    <div class="col-md-3">
        <select name="client" class="form-control">
            <option value="">Cliente</option>
            {% for c in clients %}
                <option value="{{ c.uuid }}">{{ c.name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-2">
        <button class="btn btn-primary w-100">Filtrar</button>
    </div>
</form>

<table class="table table-dark table-striped">
    <thead>
        <tr>
            <th>Data</th>
            <th>Cliente</th>
            <th>Local</th>
            <th>Valor</th>
            <th>Pago</th>
            <th>Ações</th>
        </tr>
    </thead>

    <tbody>
        {% for s in shows %}
        <tr>
            <td>{{ s.show_date }}</td>
            <td>{{ s.client.name }}</td>
            <td>{{ s.place.name }}</td>
            <td>R$ {{ s.value }}</td>
            <td id="paid-{{ s.uuid }}">{% if s.paid %}✔️{% else %}❌{% endif %}</td>
            <td>
                <a href="/shows/{{ s.uuid }}/edit" class="btn btn-warning btn-sm">Editar</a>

                <button 
                    class="btn btn-success btn-sm"
                    onclick="markPaid('{{ s.uuid }}', this)"
                >
                    Pago
                </button>

                <form action="/shows/{{ s.uuid }}/delete" method="POST" style="display:inline;" 
                    onsubmit="return confirm('Deseja excluir?');">
                    <button class="btn btn-danger btn-sm">Excluir</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
async function markPaid(id, button) {
    if (!confirm("Marcar este show como pago?")) return;

    button.disabled = true;
    button.innerText = "Processando...";

    const response = await fetch(`/shows/${id}/pay`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("access_token")
        }
    });

    if (response.ok) {
        button.innerText = "Pago ✔";
        button.classList.remove("btn-success");
        button.classList.add("btn-secondary");

        document.getElementById("paid-" + id).innerHTML = "✔️";
    } else {
        button.disabled = false;
        button.innerText = "Pago";
        alert("Erro ao marcar como pago.");
    }
}
</script>

{% endblock %}
